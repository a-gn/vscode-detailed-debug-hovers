name: Publish VSCode Extension

on:
  # Trigger on tag push with format release/vX.Y.Z
  push:
    tags:
      - 'release/v*.*.*'

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: Deployment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: extract_version
        run: |
          # Extract version from tag (release/vX.Y.Z -> X.Y.Z)
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "Full tag: $TAG_NAME"

          # Remove 'release/v' prefix to get version
          VERSION="${TAG_NAME#release/v}"
          echo "Extracted version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Validate version matches package.json
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="${{ steps.extract_version.outputs.version }}"

          echo "Package.json version: $PACKAGE_VERSION"
          echo "Tag version: $TAG_VERSION"

          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "❌ Error: Version mismatch!"
            echo "  Tag version: $TAG_VERSION"
            echo "  package.json version: $PACKAGE_VERSION"
            echo "  Please ensure the tag matches the version in package.json"
            exit 1
          fi

          echo "✅ Version validation passed: $PACKAGE_VERSION"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile TypeScript
        run: npm run compile

      - name: Run unit tests
        run: npm run test:unit

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Publish to VSCode Marketplace
        run: vsce publish
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Package extension
        run: vsce package

      - name: Create GitHub Release
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          gh release create "release/v$VERSION" \
            --title "Release v$VERSION" \
            --generate-notes \
            array-inspector-$VERSION.vsix
        env:
          GH_TOKEN: ${{ github.token }}
